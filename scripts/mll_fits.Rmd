---
title: "MFE distributions Maximum likelihood"
author: "JT McCrone"
date: "April 22, 2016"
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,tidy=T,warning=F)
require(plyr)
require(bbmle)
require(ggplot2)
theme_set(new = theme_classic()+ theme(
axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'))) # to make nice plots
```


In this document we'll try to fit the distribution of the MFE using maximum likelihood methods and the r package bbmle. We'll also rely on Rs built in distributions and for the time being we'll be using the data in Ashley _et. al_ until the influenza data is ready.

```{r,the_data}

data.df<-read.csv("../data/flu.csv",stringsAsFactors = F)

ggplot(data.df,aes(x=Total.Hist))+geom_histogram()
```

To start we'll use the models from Sanjuan 2004 and to make things even easier we'll just look at the simple noncompounded models first and save the compounded ones for later. If I understand the paper correctly they just model the distribution of the negative effects (<1.0 , not necessarily significant) that are not lethal. We could model the lethal effects with a zero-inflated model, but we'll save that for later.

I'll subset the data above to include the non-lethal negative fitnesses
```{r}
model.df<-mutate(data.df,Fitness=Total.CDF) # change this to other columns if you'd like to model those as well.
model.df<-subset(model.df,Fitness>0 & Fitness<1)
ggplot(model.df,aes(x=Fitness))+geom_histogram()
```

### functions


```{r,NLL_functions}
gammaNLL<-function(shape,scale,data){ # gamma negative log likelihood
  -sum(dgamma(data,shape=shape,scale=scale,log=T)) # the negative of the sum of the prob of seeing the data give the shape and scale parameters. Log transform the probabilities
}

gamma_fit<-function(fitness){
  m=mean(fitness)
  vm=var(fitness)/mean(fitness)
  
  gammamodel<-mle2(gammaNLL,start=list(shape = m/vm, scale = vm),data = list(data=fitness))
  gammamodel
  AIC(gammamodel,k=2)
}


betaNLL<-function(a,b,data){
  #print(data)
   -sum(dbeta(data,shape1=a,shape2=b,log=T))
}

beta_fit<-function(fitness){
  data<-fitness
 # print(data)
  betamodel<-mle2(betaNLL,start=list(a = 5, b = 5),data = list(data=fitness))
  betamodel
  AIC(betamodel,k=2)
}
#plot(profile(betamodel))


WeibullNLL<-function(a,b,data){
    -sum(dweibull(data,shape=a,scale=b,log=T))

}

weibull_fit<-function(fitness){
  weibullmodel<-mle2(WeibullNLL,start=list(a = 5, b = 5),data=list(data=fitness))
  weibullmodel
  AIC(weibullmodel,k=2)
}


lognormalNLL<-function(a,b,data){
    -sum(dlnorm(data,meanlog=a,sdlog = b,log=T))

}

lnorm_fit<-function(fitness){
  lnormmodel<-mle2(lognormalNLL,start=list(a = mean(log(fitness)), b = sd(log(fitness))),data=list(data=fitness))
  lnormmodel
  AIC(lnormmodel,k=2)
}


expNLL<-function(a,data){
  -sum(dexp(data,rate=a,log=T))
}

exp_fit<-function(fitness){
  expmodel<-mle2(expNLL,start=list(a = 1/mean(fitness)),data=list(data=fitness))
  expmodel
  AIC(expmodel,k=1)
}

```


# Flu MFE Table

```{r,results='asis'}

make_table<-function(data){
  fitness<-data[which(data<1)]
  x<-data.frame(Distribution=c("Exponential","Gamma","Beta","Weibull","Lognormal"),AIC=c(exp_fit(fitness),gamma_fit(fitness),beta_fit(fitness),weibull_fit(fitness),lnorm_fit(fitness)))
}

total<-make_table(data.df$Total.CDF)

random<-make_table(data.df$Random.CDF)
surface<-make_table(data.df$Surface.CDF)
internal<-make_table(data.df$Internal.CDF)


all_table<-data.frame(Distribution=c("Exponential","Gamma","Beta","Weibull","Lognormal"),Total=total$AIC,Random=random$AIC,Surface=surface$AIC,Internal=internal$AIC)

knitr::kable(all_table)
```




## Adding uniform distributions

In this analyis we add a uniform distribution. We ARE NOT letting the parameters vary but rather are letting a proportion of the variants fall on a uniform distribution between 0 and some parameter b.


###Exponential + uniform

```{r}
expUniNLL<-function(a,p,m){
    expll<-p*dexp(model.df$Fitness,rate=a)
  unill<-(1-p)*dunif(model.df$Fitness,0,m)
  likeli<-sum(expll,unill,na.rm = T)
  LL=-sum(log(likeli))
  
  #print(c(a,p,m))
  #print(LL)

  if(is.finite(LL)) return(LL)
  else return (1000)
}

expUnimodel<-mle2(expUniNLL,start=list(a = 1/mean(model.df$Fitness),p=0.5,m=0.5),method="L-BFGS-B",lower=c(0,0,0),upper=c(100,1,1))
expUnimodel
AIC(expUnimodel,k=3)


```





### Gamma + uniform

```{r,gammaUni}
gammaUniNLL<-function(a,b,p,m){ # gamma negative log likelihood
  gammall<-p*dgamma(model.df$Fitness,shape=a,scale=b)
  unill<-(1-p)*dunif(model.df$Fitness,0,m)
  likeli<-sum(gammall,unill,na.rm = T)
  LL=-sum(log(likeli))
  #LL<-sum(log(p*dgamma(model.df$Fitness,shape=a,scale=b)+(1-p)*dunif(model.df$Fitness,0,m))) # the negative of the sum of the prob of seeing the data give the shape and scale parameters. Log transform the probabilities
#  print(c(a,b,p,m))
 # print(LL)

  if(is.finite(LL)) return(LL)
  else return (1000)
}

m=mean(model.df$Fitness)
vm=var(model.df$Fitness)/mean(model.df$Fitness)

gammaUniModel<-mle2(gammaUniNLL,start=list(a = m/vm, b =vm ,p=0.5,m=0.5),method="L-BFGS-B",lower=list(p=0,m=0),upper=list(p=1,m=1))
gammaUniModel
AIC(gammaUniModel,k=4)

```

 The extra distributions aren't really adding anything.



# Polio MFE data

This is fitting the polio fitness data. I have selected for fitness values between 0 and 1.
```{r}
polio<-read.csv("../data/AshleyFig4.csv")
polio<-subset(polio,Fitness>0 & Fitness <1)

polio.tb<-make_table(polio$Fitness)

knitr::kable(polio.tb)
```


